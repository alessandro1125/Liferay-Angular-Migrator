{"version":3,"sources":["../../../../../../../../../../../../../packages/animations/browser/src/render/css_keyframes/element_animation_style_handler.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\nconst ELAPSED_TIME_MAX_DECIMAL_PLACES = 3;\nconst ANIMATION_PROP = 'animation';\nconst ANIMATIONEND_EVENT = 'animationend';\nconst ONE_SECOND = 1000;\n\nexport class ElementAnimationStyleHandler {\n  private readonly _eventFn: (e: any) => any;\n  private _finished = false;\n  private _destroyed = false;\n  private _startTime = 0;\n  private _position = 0;\n\n  constructor(\n      private readonly _element: any, private readonly _name: string,\n      private readonly _duration: number, private readonly _delay: number,\n      private readonly _easing: string, private readonly _fillMode: ''|'both'|'forwards',\n      private readonly _onDoneFn: () => any) {\n    this._eventFn = (e) => this._handleCallback(e);\n  }\n\n  apply() {\n    applyKeyframeAnimation(\n        this._element,\n        `${this._duration}ms ${this._easing} ${this._delay}ms 1 normal ${this._fillMode} ${this._name}`);\n    addRemoveAnimationEvent(this._element, this._eventFn, false);\n    this._startTime = Date.now();\n  }\n\n  pause() { playPauseAnimation(this._element, this._name, 'paused'); }\n\n  resume() { playPauseAnimation(this._element, this._name, 'running'); }\n\n  setPosition(position: number) {\n    const index = findIndexForAnimation(this._element, this._name);\n    this._position = position * this._duration;\n    setAnimationStyle(this._element, 'Delay', `-${this._position}ms`, index);\n  }\n\n  getPosition() { return this._position; }\n\n  private _handleCallback(event: any) {\n    const timestamp = event._ngTestManualTimestamp || Date.now();\n    const elapsedTime =\n        parseFloat(event.elapsedTime.toFixed(ELAPSED_TIME_MAX_DECIMAL_PLACES)) * ONE_SECOND;\n    if (event.animationName == this._name &&\n        Math.max(timestamp - this._startTime, 0) >= this._delay && elapsedTime >= this._duration) {\n      this.finish();\n    }\n  }\n\n  finish() {\n    if (this._finished) return;\n    this._finished = true;\n    this._onDoneFn();\n    addRemoveAnimationEvent(this._element, this._eventFn, true);\n  }\n\n  destroy() {\n    if (this._destroyed) return;\n    this._destroyed = true;\n    this.finish();\n    removeKeyframeAnimation(this._element, this._name);\n  }\n}\n\nfunction playPauseAnimation(element: any, name: string, status: 'running' | 'paused') {\n  const index = findIndexForAnimation(element, name);\n  setAnimationStyle(element, 'PlayState', status, index);\n}\n\nfunction applyKeyframeAnimation(element: any, value: string): number {\n  const anim = getAnimationStyle(element, '').trim();\n  let index = 0;\n  if (anim.length) {\n    index = countChars(anim, ',') + 1;\n    value = `${anim}, ${value}`;\n  }\n  setAnimationStyle(element, '', value);\n  return index;\n}\n\nfunction removeKeyframeAnimation(element: any, name: string) {\n  const anim = getAnimationStyle(element, '');\n  const tokens = anim.split(',');\n  const index = findMatchingTokenIndex(tokens, name);\n  if (index >= 0) {\n    tokens.splice(index, 1);\n    const newValue = tokens.join(',');\n    setAnimationStyle(element, '', newValue);\n  }\n}\n\nfunction findIndexForAnimation(element: any, value: string) {\n  const anim = getAnimationStyle(element, '');\n  if (anim.indexOf(',') > 0) {\n    const tokens = anim.split(',');\n    return findMatchingTokenIndex(tokens, value);\n  }\n  return findMatchingTokenIndex([anim], value);\n}\n\nfunction findMatchingTokenIndex(tokens: string[], searchToken: string): number {\n  for (let i = 0; i < tokens.length; i++) {\n    if (tokens[i].indexOf(searchToken) >= 0) {\n      return i;\n    }\n  }\n  return -1;\n}\n\nfunction addRemoveAnimationEvent(element: any, fn: (e: any) => any, doRemove: boolean) {\n  doRemove ? element.removeEventListener(ANIMATIONEND_EVENT, fn) :\n             element.addEventListener(ANIMATIONEND_EVENT, fn);\n}\n\nfunction setAnimationStyle(element: any, name: string, value: string, index?: number) {\n  const prop = ANIMATION_PROP + name;\n  if (index != null) {\n    const oldValue = element.style[prop];\n    if (oldValue.length) {\n      const tokens = oldValue.split(',');\n      tokens[index] = value;\n      value = tokens.join(',');\n    }\n  }\n  element.style[prop] = value;\n}\n\nfunction getAnimationStyle(element: any, name: string) {\n  return element.style[ANIMATION_PROP + name];\n}\n\nfunction countChars(value: string, char: string): number {\n  let count = 0;\n  for (let i = 0; i < value.length; i++) {\n    const c = value.charAt(i);\n    if (c === char) count++;\n  }\n  return count;\n}\n"],"sourceRoot":""}