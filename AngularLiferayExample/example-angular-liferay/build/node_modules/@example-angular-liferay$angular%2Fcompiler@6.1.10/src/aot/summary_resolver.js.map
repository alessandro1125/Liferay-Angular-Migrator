{"version":3,"sources":["../../../../../../../packages/compiler/src/aot/summary_resolver.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {Summary, SummaryResolver} from '../summary_resolver';\n\nimport {StaticSymbol, StaticSymbolCache} from './static_symbol';\nimport {deserializeSummaries} from './summary_serializer';\nimport {stripGeneratedFileSuffix, summaryFileName} from './util';\n\nexport interface AotSummaryResolverHost {\n  /**\n   * Loads an NgModule/Directive/Pipe summary file\n   */\n  loadSummary(filePath: string): string|null;\n\n  /**\n   * Returns whether a file is a source file or not.\n   */\n  isSourceFile(sourceFilePath: string): boolean;\n  /**\n   * Converts a file name into a representation that should be stored in a summary file.\n   * This has to include changing the suffix as well.\n   * E.g.\n   * `some_file.ts` -> `some_file.d.ts`\n   *\n   * @param referringSrcFileName the soure file that refers to fileName\n   */\n  toSummaryFileName(fileName: string, referringSrcFileName: string): string;\n\n  /**\n   * Converts a fileName that was processed by `toSummaryFileName` back into a real fileName\n   * given the fileName of the library that is referrig to it.\n   */\n  fromSummaryFileName(fileName: string, referringLibFileName: string): string;\n}\n\nexport class AotSummaryResolver implements SummaryResolver<StaticSymbol> {\n  // Note: this will only contain StaticSymbols without members!\n  private summaryCache = new Map<StaticSymbol, Summary<StaticSymbol>>();\n  private loadedFilePaths = new Map<string, boolean>();\n  // Note: this will only contain StaticSymbols without members!\n  private importAs = new Map<StaticSymbol, StaticSymbol>();\n  private knownFileNameToModuleNames = new Map<string, string>();\n\n  constructor(private host: AotSummaryResolverHost, private staticSymbolCache: StaticSymbolCache) {}\n\n  isLibraryFile(filePath: string): boolean {\n    // Note: We need to strip the .ngfactory. file path,\n    // so this method also works for generated files\n    // (for which host.isSourceFile will always return false).\n    return !this.host.isSourceFile(stripGeneratedFileSuffix(filePath));\n  }\n\n  toSummaryFileName(filePath: string, referringSrcFileName: string) {\n    return this.host.toSummaryFileName(filePath, referringSrcFileName);\n  }\n\n  fromSummaryFileName(fileName: string, referringLibFileName: string) {\n    return this.host.fromSummaryFileName(fileName, referringLibFileName);\n  }\n\n  resolveSummary(staticSymbol: StaticSymbol): Summary<StaticSymbol>|null {\n    const rootSymbol = staticSymbol.members.length ?\n        this.staticSymbolCache.get(staticSymbol.filePath, staticSymbol.name) :\n        staticSymbol;\n    let summary = this.summaryCache.get(rootSymbol);\n    if (!summary) {\n      this._loadSummaryFile(staticSymbol.filePath);\n      summary = this.summaryCache.get(staticSymbol) !;\n    }\n    return (rootSymbol === staticSymbol && summary) || null;\n  }\n\n  getSymbolsOf(filePath: string): StaticSymbol[]|null {\n    if (this._loadSummaryFile(filePath)) {\n      return Array.from(this.summaryCache.keys()).filter((symbol) => symbol.filePath === filePath);\n    }\n    return null;\n  }\n\n  getImportAs(staticSymbol: StaticSymbol): StaticSymbol {\n    staticSymbol.assertNoMembers();\n    return this.importAs.get(staticSymbol) !;\n  }\n\n  /**\n   * Converts a file path to a module name that can be used as an `import`.\n   */\n  getKnownModuleName(importedFilePath: string): string|null {\n    return this.knownFileNameToModuleNames.get(importedFilePath) || null;\n  }\n\n  addSummary(summary: Summary<StaticSymbol>) { this.summaryCache.set(summary.symbol, summary); }\n\n  private _loadSummaryFile(filePath: string): boolean {\n    let hasSummary = this.loadedFilePaths.get(filePath);\n    if (hasSummary != null) {\n      return hasSummary;\n    }\n    let json: string|null = null;\n    if (this.isLibraryFile(filePath)) {\n      const summaryFilePath = summaryFileName(filePath);\n      try {\n        json = this.host.loadSummary(summaryFilePath);\n      } catch (e) {\n        console.error(`Error loading summary file ${summaryFilePath}`);\n        throw e;\n      }\n    }\n    hasSummary = json != null;\n    this.loadedFilePaths.set(filePath, hasSummary);\n    if (json) {\n      const {moduleName, summaries, importAs} =\n          deserializeSummaries(this.staticSymbolCache, this, filePath, json);\n      summaries.forEach((summary) => this.summaryCache.set(summary.symbol, summary));\n      if (moduleName) {\n        this.knownFileNameToModuleNames.set(filePath, moduleName);\n      }\n      importAs.forEach((importAs) => { this.importAs.set(importAs.symbol, importAs.importAs); });\n    }\n    return hasSummary;\n  }\n}\n"],"sourceRoot":""}