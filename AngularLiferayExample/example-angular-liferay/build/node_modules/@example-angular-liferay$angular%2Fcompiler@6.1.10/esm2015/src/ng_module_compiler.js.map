{"version":3,"sources":["../../../../../../packages/compiler/src/ng_module_compiler.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {CompileNgModuleMetadata, CompileProviderMetadata, identifierName} from './compile_metadata';\nimport {CompileReflector} from './compile_reflector';\nimport {NodeFlags} from './core';\nimport {Identifiers} from './identifiers';\nimport * as o from './output/output_ast';\nimport {typeSourceSpan} from './parse_util';\nimport {NgModuleProviderAnalyzer} from './provider_analyzer';\nimport {OutputContext} from './util';\nimport {componentFactoryResolverProviderDef, depDef, providerDef} from './view_compiler/provider_compiler';\n\nexport class NgModuleCompileResult {\n  constructor(public ngModuleFactoryVar: string) {}\n}\n\nconst LOG_VAR = o.variable('_l');\n\nexport class NgModuleCompiler {\n  constructor(private reflector: CompileReflector) {}\n  compile(\n      ctx: OutputContext, ngModuleMeta: CompileNgModuleMetadata,\n      extraProviders: CompileProviderMetadata[]): NgModuleCompileResult {\n    const sourceSpan = typeSourceSpan('NgModule', ngModuleMeta.type);\n    const entryComponentFactories = ngModuleMeta.transitiveModule.entryComponents;\n    const bootstrapComponents = ngModuleMeta.bootstrapComponents;\n    const providerParser =\n        new NgModuleProviderAnalyzer(this.reflector, ngModuleMeta, extraProviders, sourceSpan);\n    const providerDefs =\n        [componentFactoryResolverProviderDef(\n             this.reflector, ctx, NodeFlags.None, entryComponentFactories)]\n            .concat(providerParser.parse().map((provider) => providerDef(ctx, provider)))\n            .map(({providerExpr, depsExpr, flags, tokenExpr}) => {\n              return o.importExpr(Identifiers.moduleProviderDef).callFn([\n                o.literal(flags), tokenExpr, providerExpr, depsExpr\n              ]);\n            });\n\n    const ngModuleDef = o.importExpr(Identifiers.moduleDef).callFn([o.literalArr(providerDefs)]);\n    const ngModuleDefFactory = o.fn(\n        [new o.FnParam(LOG_VAR.name !)], [new o.ReturnStatement(ngModuleDef)], o.INFERRED_TYPE);\n\n    const ngModuleFactoryVar = `${identifierName(ngModuleMeta.type)}NgFactory`;\n    this._createNgModuleFactory(\n        ctx, ngModuleMeta.type.reference, o.importExpr(Identifiers.createModuleFactory).callFn([\n          ctx.importExpr(ngModuleMeta.type.reference),\n          o.literalArr(bootstrapComponents.map(id => ctx.importExpr(id.reference))),\n          ngModuleDefFactory\n        ]));\n\n    if (ngModuleMeta.id) {\n      const id = typeof ngModuleMeta.id === 'string' ? o.literal(ngModuleMeta.id) :\n                                                       ctx.importExpr(ngModuleMeta.id);\n      const registerFactoryStmt = o.importExpr(Identifiers.RegisterModuleFactoryFn)\n                                      .callFn([id, o.variable(ngModuleFactoryVar)])\n                                      .toStmt();\n      ctx.statements.push(registerFactoryStmt);\n    }\n\n    return new NgModuleCompileResult(ngModuleFactoryVar);\n  }\n\n  createStub(ctx: OutputContext, ngModuleReference: any) {\n    this._createNgModuleFactory(ctx, ngModuleReference, o.NULL_EXPR);\n  }\n\n  private _createNgModuleFactory(ctx: OutputContext, reference: any, value: o.Expression) {\n    const ngModuleFactoryVar = `${identifierName({reference: reference})}NgFactory`;\n    const ngModuleFactoryStmt =\n        o.variable(ngModuleFactoryVar)\n            .set(value)\n            .toDeclStmt(\n                o.importType(\n                    Identifiers.NgModuleFactory, [o.expressionType(ctx.importExpr(reference)) !],\n                    [o.TypeModifier.Const]),\n                [o.StmtModifier.Final, o.StmtModifier.Exported]);\n\n    ctx.statements.push(ngModuleFactoryStmt);\n  }\n}\n"],"sourceRoot":""}