{"version":3,"sources":["../../../../../../../../../../../packages/compiler/src/i18n/serializers/xtb.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport * as ml from '../../ml_parser/ast';\nimport {XmlParser} from '../../ml_parser/xml_parser';\nimport * as i18n from '../i18n_ast';\nimport {I18nError} from '../parse_util';\n\nimport {PlaceholderMapper, Serializer, SimplePlaceholderMapper} from './serializer';\nimport {digest, toPublicName} from './xmb';\n\nconst _TRANSLATIONS_TAG = 'translationbundle';\nconst _TRANSLATION_TAG = 'translation';\nconst _PLACEHOLDER_TAG = 'ph';\n\nexport class Xtb extends Serializer {\n  write(messages: i18n.Message[], locale: string|null): string { throw new Error('Unsupported'); }\n\n  load(content: string, url: string):\n      {locale: string, i18nNodesByMsgId: {[msgId: string]: i18n.Node[]}} {\n    // xtb to xml nodes\n    const xtbParser = new XtbParser();\n    const {locale, msgIdToHtml, errors} = xtbParser.parse(content, url);\n\n    // xml nodes to i18n nodes\n    const i18nNodesByMsgId: {[msgId: string]: i18n.Node[]} = {};\n    const converter = new XmlToI18n();\n\n    // Because we should be able to load xtb files that rely on features not supported by angular,\n    // we need to delay the conversion of html to i18n nodes so that non angular messages are not\n    // converted\n    Object.keys(msgIdToHtml).forEach(msgId => {\n      const valueFn = function() {\n        const {i18nNodes, errors} = converter.convert(msgIdToHtml[msgId], url);\n        if (errors.length) {\n          throw new Error(`xtb parse errors:\\n${errors.join('\\n')}`);\n        }\n        return i18nNodes;\n      };\n      createLazyProperty(i18nNodesByMsgId, msgId, valueFn);\n    });\n\n    if (errors.length) {\n      throw new Error(`xtb parse errors:\\n${errors.join('\\n')}`);\n    }\n\n    return {locale: locale !, i18nNodesByMsgId};\n  }\n\n  digest(message: i18n.Message): string { return digest(message); }\n\n  createNameMapper(message: i18n.Message): PlaceholderMapper {\n    return new SimplePlaceholderMapper(message, toPublicName);\n  }\n}\n\nfunction createLazyProperty(messages: any, id: string, valueFn: () => any) {\n  Object.defineProperty(messages, id, {\n    configurable: true,\n    enumerable: true,\n    get: function() {\n      const value = valueFn();\n      Object.defineProperty(messages, id, {enumerable: true, value});\n      return value;\n    },\n    set: _ => { throw new Error('Could not overwrite an XTB translation'); },\n  });\n}\n\n// Extract messages as xml nodes from the xtb file\nclass XtbParser implements ml.Visitor {\n  // TODO(issue/24571): remove '!'.\n  private _bundleDepth !: number;\n  // TODO(issue/24571): remove '!'.\n  private _errors !: I18nError[];\n  // TODO(issue/24571): remove '!'.\n  private _msgIdToHtml !: {[msgId: string]: string};\n  private _locale: string|null = null;\n\n  parse(xtb: string, url: string) {\n    this._bundleDepth = 0;\n    this._msgIdToHtml = {};\n\n    // We can not parse the ICU messages at this point as some messages might not originate\n    // from Angular that could not be lex'd.\n    const xml = new XmlParser().parse(xtb, url, false);\n\n    this._errors = xml.errors;\n    ml.visitAll(this, xml.rootNodes);\n\n    return {\n      msgIdToHtml: this._msgIdToHtml,\n      errors: this._errors,\n      locale: this._locale,\n    };\n  }\n\n  visitElement(element: ml.Element, context: any): any {\n    switch (element.name) {\n      case _TRANSLATIONS_TAG:\n        this._bundleDepth++;\n        if (this._bundleDepth > 1) {\n          this._addError(element, `<${_TRANSLATIONS_TAG}> elements can not be nested`);\n        }\n        const langAttr = element.attrs.find((attr) => attr.name === 'lang');\n        if (langAttr) {\n          this._locale = langAttr.value;\n        }\n        ml.visitAll(this, element.children, null);\n        this._bundleDepth--;\n        break;\n\n      case _TRANSLATION_TAG:\n        const idAttr = element.attrs.find((attr) => attr.name === 'id');\n        if (!idAttr) {\n          this._addError(element, `<${_TRANSLATION_TAG}> misses the \"id\" attribute`);\n        } else {\n          const id = idAttr.value;\n          if (this._msgIdToHtml.hasOwnProperty(id)) {\n            this._addError(element, `Duplicated translations for msg ${id}`);\n          } else {\n            const innerTextStart = element.startSourceSpan !.end.offset;\n            const innerTextEnd = element.endSourceSpan !.start.offset;\n            const content = element.startSourceSpan !.start.file.content;\n            const innerText = content.slice(innerTextStart !, innerTextEnd !);\n            this._msgIdToHtml[id] = innerText;\n          }\n        }\n        break;\n\n      default:\n        this._addError(element, 'Unexpected tag');\n    }\n  }\n\n  visitAttribute(attribute: ml.Attribute, context: any): any {}\n\n  visitText(text: ml.Text, context: any): any {}\n\n  visitComment(comment: ml.Comment, context: any): any {}\n\n  visitExpansion(expansion: ml.Expansion, context: any): any {}\n\n  visitExpansionCase(expansionCase: ml.ExpansionCase, context: any): any {}\n\n  private _addError(node: ml.Node, message: string): void {\n    this._errors.push(new I18nError(node.sourceSpan !, message));\n  }\n}\n\n// Convert ml nodes (xtb syntax) to i18n nodes\nclass XmlToI18n implements ml.Visitor {\n  // TODO(issue/24571): remove '!'.\n  private _errors !: I18nError[];\n\n  convert(message: string, url: string) {\n    const xmlIcu = new XmlParser().parse(message, url, true);\n    this._errors = xmlIcu.errors;\n\n    const i18nNodes = this._errors.length > 0 || xmlIcu.rootNodes.length == 0 ?\n        [] :\n        ml.visitAll(this, xmlIcu.rootNodes);\n\n    return {\n      i18nNodes,\n      errors: this._errors,\n    };\n  }\n\n  visitText(text: ml.Text, context: any) { return new i18n.Text(text.value, text.sourceSpan !); }\n\n  visitExpansion(icu: ml.Expansion, context: any) {\n    const caseMap: {[value: string]: i18n.Node} = {};\n\n    ml.visitAll(this, icu.cases).forEach(c => {\n      caseMap[c.value] = new i18n.Container(c.nodes, icu.sourceSpan);\n    });\n\n    return new i18n.Icu(icu.switchValue, icu.type, caseMap, icu.sourceSpan);\n  }\n\n  visitExpansionCase(icuCase: ml.ExpansionCase, context: any): any {\n    return {\n      value: icuCase.value,\n      nodes: ml.visitAll(this, icuCase.expression),\n    };\n  }\n\n  visitElement(el: ml.Element, context: any): i18n.Placeholder|null {\n    if (el.name === _PLACEHOLDER_TAG) {\n      const nameAttr = el.attrs.find((attr) => attr.name === 'name');\n      if (nameAttr) {\n        return new i18n.Placeholder('', nameAttr.value, el.sourceSpan !);\n      }\n\n      this._addError(el, `<${_PLACEHOLDER_TAG}> misses the \"name\" attribute`);\n    } else {\n      this._addError(el, `Unexpected tag`);\n    }\n    return null;\n  }\n\n  visitComment(comment: ml.Comment, context: any) {}\n\n  visitAttribute(attribute: ml.Attribute, context: any) {}\n\n  private _addError(node: ml.Node, message: string): void {\n    this._errors.push(new I18nError(node.sourceSpan !, message));\n  }\n}\n"],"sourceRoot":""}