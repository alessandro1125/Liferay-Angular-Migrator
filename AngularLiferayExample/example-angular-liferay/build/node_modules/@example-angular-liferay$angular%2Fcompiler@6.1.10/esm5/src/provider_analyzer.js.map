{"version":3,"sources":["../../../../../../../../../packages/compiler/src/provider_analyzer.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\n\nimport {CompileDiDependencyMetadata, CompileDirectiveMetadata, CompileDirectiveSummary, CompileNgModuleMetadata, CompileProviderMetadata, CompileQueryMetadata, CompileTokenMetadata, CompileTypeMetadata, tokenName, tokenReference} from './compile_metadata';\nimport {CompileReflector} from './compile_reflector';\nimport {Identifiers, createTokenForExternalReference} from './identifiers';\nimport {ParseError, ParseSourceSpan} from './parse_util';\nimport {AttrAst, DirectiveAst, ProviderAst, ProviderAstType, QueryMatch, ReferenceAst} from './template_parser/template_ast';\n\nexport class ProviderError extends ParseError {\n  constructor(message: string, span: ParseSourceSpan) { super(span, message); }\n}\n\nexport interface QueryWithId {\n  meta: CompileQueryMetadata;\n  queryId: number;\n}\n\nexport class ProviderViewContext {\n  /**\n   * @internal\n   */\n  viewQueries: Map<any, QueryWithId[]>;\n  /**\n   * @internal\n   */\n  viewProviders: Map<any, boolean>;\n  errors: ProviderError[] = [];\n\n  constructor(public reflector: CompileReflector, public component: CompileDirectiveMetadata) {\n    this.viewQueries = _getViewQueries(component);\n    this.viewProviders = new Map<any, boolean>();\n    component.viewProviders.forEach((provider) => {\n      if (this.viewProviders.get(tokenReference(provider.token)) == null) {\n        this.viewProviders.set(tokenReference(provider.token), true);\n      }\n    });\n  }\n}\n\nexport class ProviderElementContext {\n  private _contentQueries: Map<any, QueryWithId[]>;\n\n  private _transformedProviders = new Map<any, ProviderAst>();\n  private _seenProviders = new Map<any, boolean>();\n  private _allProviders: Map<any, ProviderAst>;\n  private _attrs: {[key: string]: string};\n  private _queriedTokens = new Map<any, QueryMatch[]>();\n\n  public readonly transformedHasViewContainer: boolean = false;\n\n  constructor(\n      public viewContext: ProviderViewContext, private _parent: ProviderElementContext,\n      private _isViewRoot: boolean, private _directiveAsts: DirectiveAst[], attrs: AttrAst[],\n      refs: ReferenceAst[], isTemplate: boolean, contentQueryStartId: number,\n      private _sourceSpan: ParseSourceSpan) {\n    this._attrs = {};\n    attrs.forEach((attrAst) => this._attrs[attrAst.name] = attrAst.value);\n    const directivesMeta = _directiveAsts.map(directiveAst => directiveAst.directive);\n    this._allProviders =\n        _resolveProvidersFromDirectives(directivesMeta, _sourceSpan, viewContext.errors);\n    this._contentQueries = _getContentQueries(contentQueryStartId, directivesMeta);\n    Array.from(this._allProviders.values()).forEach((provider) => {\n      this._addQueryReadsTo(provider.token, provider.token, this._queriedTokens);\n    });\n    if (isTemplate) {\n      const templateRefId =\n          createTokenForExternalReference(this.viewContext.reflector, Identifiers.TemplateRef);\n      this._addQueryReadsTo(templateRefId, templateRefId, this._queriedTokens);\n    }\n    refs.forEach((refAst) => {\n      let defaultQueryValue = refAst.value ||\n          createTokenForExternalReference(this.viewContext.reflector, Identifiers.ElementRef);\n      this._addQueryReadsTo({value: refAst.name}, defaultQueryValue, this._queriedTokens);\n    });\n    if (this._queriedTokens.get(\n            this.viewContext.reflector.resolveExternalReference(Identifiers.ViewContainerRef))) {\n      this.transformedHasViewContainer = true;\n    }\n\n    // create the providers that we know are eager first\n    Array.from(this._allProviders.values()).forEach((provider) => {\n      const eager = provider.eager || this._queriedTokens.get(tokenReference(provider.token));\n      if (eager) {\n        this._getOrCreateLocalProvider(provider.providerType, provider.token, true);\n      }\n    });\n  }\n\n  afterElement() {\n    // collect lazy providers\n    Array.from(this._allProviders.values()).forEach((provider) => {\n      this._getOrCreateLocalProvider(provider.providerType, provider.token, false);\n    });\n  }\n\n  get transformProviders(): ProviderAst[] {\n    // Note: Maps keep their insertion order.\n    const lazyProviders: ProviderAst[] = [];\n    const eagerProviders: ProviderAst[] = [];\n    this._transformedProviders.forEach(provider => {\n      if (provider.eager) {\n        eagerProviders.push(provider);\n      } else {\n        lazyProviders.push(provider);\n      }\n    });\n    return lazyProviders.concat(eagerProviders);\n  }\n\n  get transformedDirectiveAsts(): DirectiveAst[] {\n    const sortedProviderTypes = this.transformProviders.map(provider => provider.token.identifier);\n    const sortedDirectives = this._directiveAsts.slice();\n    sortedDirectives.sort(\n        (dir1, dir2) => sortedProviderTypes.indexOf(dir1.directive.type) -\n            sortedProviderTypes.indexOf(dir2.directive.type));\n    return sortedDirectives;\n  }\n\n  get queryMatches(): QueryMatch[] {\n    const allMatches: QueryMatch[] = [];\n    this._queriedTokens.forEach((matches: QueryMatch[]) => { allMatches.push(...matches); });\n    return allMatches;\n  }\n\n  private _addQueryReadsTo(\n      token: CompileTokenMetadata, defaultValue: CompileTokenMetadata,\n      queryReadTokens: Map<any, QueryMatch[]>) {\n    this._getQueriesFor(token).forEach((query) => {\n      const queryValue = query.meta.read || defaultValue;\n      const tokenRef = tokenReference(queryValue);\n      let queryMatches = queryReadTokens.get(tokenRef);\n      if (!queryMatches) {\n        queryMatches = [];\n        queryReadTokens.set(tokenRef, queryMatches);\n      }\n      queryMatches.push({queryId: query.queryId, value: queryValue});\n    });\n  }\n\n  private _getQueriesFor(token: CompileTokenMetadata): QueryWithId[] {\n    const result: QueryWithId[] = [];\n    let currentEl: ProviderElementContext = this;\n    let distance = 0;\n    let queries: QueryWithId[]|undefined;\n    while (currentEl !== null) {\n      queries = currentEl._contentQueries.get(tokenReference(token));\n      if (queries) {\n        result.push(...queries.filter((query) => query.meta.descendants || distance <= 1));\n      }\n      if (currentEl._directiveAsts.length > 0) {\n        distance++;\n      }\n      currentEl = currentEl._parent;\n    }\n    queries = this.viewContext.viewQueries.get(tokenReference(token));\n    if (queries) {\n      result.push(...queries);\n    }\n    return result;\n  }\n\n\n  private _getOrCreateLocalProvider(\n      requestingProviderType: ProviderAstType, token: CompileTokenMetadata,\n      eager: boolean): ProviderAst|null {\n    const resolvedProvider = this._allProviders.get(tokenReference(token));\n    if (!resolvedProvider || ((requestingProviderType === ProviderAstType.Directive ||\n                               requestingProviderType === ProviderAstType.PublicService) &&\n                              resolvedProvider.providerType === ProviderAstType.PrivateService) ||\n        ((requestingProviderType === ProviderAstType.PrivateService ||\n          requestingProviderType === ProviderAstType.PublicService) &&\n         resolvedProvider.providerType === ProviderAstType.Builtin)) {\n      return null;\n    }\n    let transformedProviderAst = this._transformedProviders.get(tokenReference(token));\n    if (transformedProviderAst) {\n      return transformedProviderAst;\n    }\n    if (this._seenProviders.get(tokenReference(token)) != null) {\n      this.viewContext.errors.push(new ProviderError(\n          `Cannot instantiate cyclic dependency! ${tokenName(token)}`, this._sourceSpan));\n      return null;\n    }\n    this._seenProviders.set(tokenReference(token), true);\n    const transformedProviders = resolvedProvider.providers.map((provider) => {\n      let transformedUseValue = provider.useValue;\n      let transformedUseExisting = provider.useExisting !;\n      let transformedDeps: CompileDiDependencyMetadata[] = undefined !;\n      if (provider.useExisting != null) {\n        const existingDiDep = this._getDependency(\n            resolvedProvider.providerType, {token: provider.useExisting}, eager) !;\n        if (existingDiDep.token != null) {\n          transformedUseExisting = existingDiDep.token;\n        } else {\n          transformedUseExisting = null !;\n          transformedUseValue = existingDiDep.value;\n        }\n      } else if (provider.useFactory) {\n        const deps = provider.deps || provider.useFactory.diDeps;\n        transformedDeps =\n            deps.map((dep) => this._getDependency(resolvedProvider.providerType, dep, eager) !);\n      } else if (provider.useClass) {\n        const deps = provider.deps || provider.useClass.diDeps;\n        transformedDeps =\n            deps.map((dep) => this._getDependency(resolvedProvider.providerType, dep, eager) !);\n      }\n      return _transformProvider(provider, {\n        useExisting: transformedUseExisting,\n        useValue: transformedUseValue,\n        deps: transformedDeps\n      });\n    });\n    transformedProviderAst =\n        _transformProviderAst(resolvedProvider, {eager: eager, providers: transformedProviders});\n    this._transformedProviders.set(tokenReference(token), transformedProviderAst);\n    return transformedProviderAst;\n  }\n\n  private _getLocalDependency(\n      requestingProviderType: ProviderAstType, dep: CompileDiDependencyMetadata,\n      eager: boolean = false): CompileDiDependencyMetadata|null {\n    if (dep.isAttribute) {\n      const attrValue = this._attrs[dep.token !.value];\n      return {isValue: true, value: attrValue == null ? null : attrValue};\n    }\n\n    if (dep.token != null) {\n      // access builtints\n      if ((requestingProviderType === ProviderAstType.Directive ||\n           requestingProviderType === ProviderAstType.Component)) {\n        if (tokenReference(dep.token) ===\n                this.viewContext.reflector.resolveExternalReference(Identifiers.Renderer) ||\n            tokenReference(dep.token) ===\n                this.viewContext.reflector.resolveExternalReference(Identifiers.ElementRef) ||\n            tokenReference(dep.token) ===\n                this.viewContext.reflector.resolveExternalReference(\n                    Identifiers.ChangeDetectorRef) ||\n            tokenReference(dep.token) ===\n                this.viewContext.reflector.resolveExternalReference(Identifiers.TemplateRef)) {\n          return dep;\n        }\n        if (tokenReference(dep.token) ===\n            this.viewContext.reflector.resolveExternalReference(Identifiers.ViewContainerRef)) {\n          (this as{transformedHasViewContainer: boolean}).transformedHasViewContainer = true;\n        }\n      }\n      // access the injector\n      if (tokenReference(dep.token) ===\n          this.viewContext.reflector.resolveExternalReference(Identifiers.Injector)) {\n        return dep;\n      }\n      // access providers\n      if (this._getOrCreateLocalProvider(requestingProviderType, dep.token, eager) != null) {\n        return dep;\n      }\n    }\n    return null;\n  }\n\n  private _getDependency(\n      requestingProviderType: ProviderAstType, dep: CompileDiDependencyMetadata,\n      eager: boolean = false): CompileDiDependencyMetadata|null {\n    let currElement: ProviderElementContext = this;\n    let currEager: boolean = eager;\n    let result: CompileDiDependencyMetadata|null = null;\n    if (!dep.isSkipSelf) {\n      result = this._getLocalDependency(requestingProviderType, dep, eager);\n    }\n    if (dep.isSelf) {\n      if (!result && dep.isOptional) {\n        result = {isValue: true, value: null};\n      }\n    } else {\n      // check parent elements\n      while (!result && currElement._parent) {\n        const prevElement = currElement;\n        currElement = currElement._parent;\n        if (prevElement._isViewRoot) {\n          currEager = false;\n        }\n        result = currElement._getLocalDependency(ProviderAstType.PublicService, dep, currEager);\n      }\n      // check @Host restriction\n      if (!result) {\n        if (!dep.isHost || this.viewContext.component.isHost ||\n            this.viewContext.component.type.reference === tokenReference(dep.token !) ||\n            this.viewContext.viewProviders.get(tokenReference(dep.token !)) != null) {\n          result = dep;\n        } else {\n          result = dep.isOptional ? {isValue: true, value: null} : null;\n        }\n      }\n    }\n    if (!result) {\n      this.viewContext.errors.push(\n          new ProviderError(`No provider for ${tokenName(dep.token!)}`, this._sourceSpan));\n    }\n    return result;\n  }\n}\n\n\nexport class NgModuleProviderAnalyzer {\n  private _transformedProviders = new Map<any, ProviderAst>();\n  private _seenProviders = new Map<any, boolean>();\n  private _allProviders: Map<any, ProviderAst>;\n  private _errors: ProviderError[] = [];\n\n  constructor(\n      private reflector: CompileReflector, ngModule: CompileNgModuleMetadata,\n      extraProviders: CompileProviderMetadata[], sourceSpan: ParseSourceSpan) {\n    this._allProviders = new Map<any, ProviderAst>();\n    ngModule.transitiveModule.modules.forEach((ngModuleType: CompileTypeMetadata) => {\n      const ngModuleProvider = {token: {identifier: ngModuleType}, useClass: ngModuleType};\n      _resolveProviders(\n          [ngModuleProvider], ProviderAstType.PublicService, true, sourceSpan, this._errors,\n          this._allProviders, /* isModule */ true);\n    });\n    _resolveProviders(\n        ngModule.transitiveModule.providers.map(entry => entry.provider).concat(extraProviders),\n        ProviderAstType.PublicService, false, sourceSpan, this._errors, this._allProviders,\n        /* isModule */ false);\n  }\n\n  parse(): ProviderAst[] {\n    Array.from(this._allProviders.values()).forEach((provider) => {\n      this._getOrCreateLocalProvider(provider.token, provider.eager);\n    });\n    if (this._errors.length > 0) {\n      const errorString = this._errors.join('\\n');\n      throw new Error(`Provider parse errors:\\n${errorString}`);\n    }\n    // Note: Maps keep their insertion order.\n    const lazyProviders: ProviderAst[] = [];\n    const eagerProviders: ProviderAst[] = [];\n    this._transformedProviders.forEach(provider => {\n      if (provider.eager) {\n        eagerProviders.push(provider);\n      } else {\n        lazyProviders.push(provider);\n      }\n    });\n    return lazyProviders.concat(eagerProviders);\n  }\n\n  private _getOrCreateLocalProvider(token: CompileTokenMetadata, eager: boolean): ProviderAst|null {\n    const resolvedProvider = this._allProviders.get(tokenReference(token));\n    if (!resolvedProvider) {\n      return null;\n    }\n    let transformedProviderAst = this._transformedProviders.get(tokenReference(token));\n    if (transformedProviderAst) {\n      return transformedProviderAst;\n    }\n    if (this._seenProviders.get(tokenReference(token)) != null) {\n      this._errors.push(new ProviderError(\n          `Cannot instantiate cyclic dependency! ${tokenName(token)}`,\n          resolvedProvider.sourceSpan));\n      return null;\n    }\n    this._seenProviders.set(tokenReference(token), true);\n    const transformedProviders = resolvedProvider.providers.map((provider) => {\n      let transformedUseValue = provider.useValue;\n      let transformedUseExisting = provider.useExisting !;\n      let transformedDeps: CompileDiDependencyMetadata[] = undefined !;\n      if (provider.useExisting != null) {\n        const existingDiDep =\n            this._getDependency({token: provider.useExisting}, eager, resolvedProvider.sourceSpan);\n        if (existingDiDep.token != null) {\n          transformedUseExisting = existingDiDep.token;\n        } else {\n          transformedUseExisting = null !;\n          transformedUseValue = existingDiDep.value;\n        }\n      } else if (provider.useFactory) {\n        const deps = provider.deps || provider.useFactory.diDeps;\n        transformedDeps =\n            deps.map((dep) => this._getDependency(dep, eager, resolvedProvider.sourceSpan));\n      } else if (provider.useClass) {\n        const deps = provider.deps || provider.useClass.diDeps;\n        transformedDeps =\n            deps.map((dep) => this._getDependency(dep, eager, resolvedProvider.sourceSpan));\n      }\n      return _transformProvider(provider, {\n        useExisting: transformedUseExisting,\n        useValue: transformedUseValue,\n        deps: transformedDeps\n      });\n    });\n    transformedProviderAst =\n        _transformProviderAst(resolvedProvider, {eager: eager, providers: transformedProviders});\n    this._transformedProviders.set(tokenReference(token), transformedProviderAst);\n    return transformedProviderAst;\n  }\n\n  private _getDependency(\n      dep: CompileDiDependencyMetadata, eager: boolean = false,\n      requestorSourceSpan: ParseSourceSpan): CompileDiDependencyMetadata {\n    let foundLocal = false;\n    if (!dep.isSkipSelf && dep.token != null) {\n      // access the injector\n      if (tokenReference(dep.token) ===\n              this.reflector.resolveExternalReference(Identifiers.Injector) ||\n          tokenReference(dep.token) ===\n              this.reflector.resolveExternalReference(Identifiers.ComponentFactoryResolver)) {\n        foundLocal = true;\n        // access providers\n      } else if (this._getOrCreateLocalProvider(dep.token, eager) != null) {\n        foundLocal = true;\n      }\n    }\n    return dep;\n  }\n}\n\nfunction _transformProvider(\n    provider: CompileProviderMetadata,\n    {useExisting, useValue, deps}:\n        {useExisting: CompileTokenMetadata, useValue: any, deps: CompileDiDependencyMetadata[]}) {\n  return {\n    token: provider.token,\n    useClass: provider.useClass,\n    useExisting: useExisting,\n    useFactory: provider.useFactory,\n    useValue: useValue,\n    deps: deps,\n    multi: provider.multi\n  };\n}\n\nfunction _transformProviderAst(\n    provider: ProviderAst,\n    {eager, providers}: {eager: boolean, providers: CompileProviderMetadata[]}): ProviderAst {\n  return new ProviderAst(\n      provider.token, provider.multiProvider, provider.eager || eager, providers,\n      provider.providerType, provider.lifecycleHooks, provider.sourceSpan, provider.isModule);\n}\n\nfunction _resolveProvidersFromDirectives(\n    directives: CompileDirectiveSummary[], sourceSpan: ParseSourceSpan,\n    targetErrors: ParseError[]): Map<any, ProviderAst> {\n  const providersByToken = new Map<any, ProviderAst>();\n  directives.forEach((directive) => {\n    const dirProvider:\n        CompileProviderMetadata = {token: {identifier: directive.type}, useClass: directive.type};\n    _resolveProviders(\n        [dirProvider],\n        directive.isComponent ? ProviderAstType.Component : ProviderAstType.Directive, true,\n        sourceSpan, targetErrors, providersByToken, /* isModule */ false);\n  });\n\n  // Note: directives need to be able to overwrite providers of a component!\n  const directivesWithComponentFirst =\n      directives.filter(dir => dir.isComponent).concat(directives.filter(dir => !dir.isComponent));\n  directivesWithComponentFirst.forEach((directive) => {\n    _resolveProviders(\n        directive.providers, ProviderAstType.PublicService, false, sourceSpan, targetErrors,\n        providersByToken, /* isModule */ false);\n    _resolveProviders(\n        directive.viewProviders, ProviderAstType.PrivateService, false, sourceSpan, targetErrors,\n        providersByToken, /* isModule */ false);\n  });\n  return providersByToken;\n}\n\nfunction _resolveProviders(\n    providers: CompileProviderMetadata[], providerType: ProviderAstType, eager: boolean,\n    sourceSpan: ParseSourceSpan, targetErrors: ParseError[],\n    targetProvidersByToken: Map<any, ProviderAst>, isModule: boolean) {\n  providers.forEach((provider) => {\n    let resolvedProvider = targetProvidersByToken.get(tokenReference(provider.token));\n    if (resolvedProvider != null && !!resolvedProvider.multiProvider !== !!provider.multi) {\n      targetErrors.push(new ProviderError(\n          `Mixing multi and non multi provider is not possible for token ${tokenName(resolvedProvider.token)}`,\n          sourceSpan));\n    }\n    if (!resolvedProvider) {\n      const lifecycleHooks = provider.token.identifier &&\n              (<CompileTypeMetadata>provider.token.identifier).lifecycleHooks ?\n          (<CompileTypeMetadata>provider.token.identifier).lifecycleHooks :\n          [];\n      const isUseValue = !(provider.useClass || provider.useExisting || provider.useFactory);\n      resolvedProvider = new ProviderAst(\n          provider.token, !!provider.multi, eager || isUseValue, [provider], providerType,\n          lifecycleHooks, sourceSpan, isModule);\n      targetProvidersByToken.set(tokenReference(provider.token), resolvedProvider);\n    } else {\n      if (!provider.multi) {\n        resolvedProvider.providers.length = 0;\n      }\n      resolvedProvider.providers.push(provider);\n    }\n  });\n}\n\n\nfunction _getViewQueries(component: CompileDirectiveMetadata): Map<any, QueryWithId[]> {\n  // Note: queries start with id 1 so we can use the number in a Bloom filter!\n  let viewQueryId = 1;\n  const viewQueries = new Map<any, QueryWithId[]>();\n  if (component.viewQueries) {\n    component.viewQueries.forEach(\n        (query) => _addQueryToTokenMap(viewQueries, {meta: query, queryId: viewQueryId++}));\n  }\n  return viewQueries;\n}\n\nfunction _getContentQueries(\n    contentQueryStartId: number, directives: CompileDirectiveSummary[]): Map<any, QueryWithId[]> {\n  let contentQueryId = contentQueryStartId;\n  const contentQueries = new Map<any, QueryWithId[]>();\n  directives.forEach((directive, directiveIndex) => {\n    if (directive.queries) {\n      directive.queries.forEach(\n          (query) => _addQueryToTokenMap(contentQueries, {meta: query, queryId: contentQueryId++}));\n    }\n  });\n  return contentQueries;\n}\n\nfunction _addQueryToTokenMap(map: Map<any, QueryWithId[]>, query: QueryWithId) {\n  query.meta.selectors.forEach((token: CompileTokenMetadata) => {\n    let entry = map.get(tokenReference(token));\n    if (!entry) {\n      entry = [];\n      map.set(tokenReference(token), entry);\n    }\n    entry.push(query);\n  });\n}\n"],"sourceRoot":""}