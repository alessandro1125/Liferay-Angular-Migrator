{"version":3,"sources":["../../../../../../../../../../packages/http/src/backends/jsonp_backend.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {Injectable} from '@angular/core';\nimport {Observable, Observer} from 'rxjs';\n\nimport {ResponseOptions} from '../base_response_options';\nimport {ReadyState, RequestMethod, ResponseType} from '../enums';\nimport {Connection, ConnectionBackend} from '../interfaces';\nimport {Request} from '../static_request';\nimport {Response} from '../static_response';\n\nimport {BrowserJsonp} from './browser_jsonp';\n\nconst JSONP_ERR_NO_CALLBACK = 'JSONP injected script did not invoke callback.';\nconst JSONP_ERR_WRONG_METHOD = 'JSONP requests must use GET request method.';\n\n/**\n * Base class for an in-flight JSONP request.\n *\n * @deprecated see https://angular.io/guide/http\n */\nexport class JSONPConnection implements Connection {\n  // TODO(issue/24571): remove '!'.\n  private _id !: string;\n  // TODO(issue/24571): remove '!'.\n  private _script !: Element;\n  private _responseData: any;\n  private _finished: boolean = false;\n\n  /**\n   * The {@link ReadyState} of this request.\n   */\n  // TODO(issue/24571): remove '!'.\n  readyState !: ReadyState;\n\n  /**\n   * The outgoing HTTP request.\n   */\n  request: Request;\n\n  /**\n   * An observable that completes with the response, when the request is finished.\n   */\n  response: Observable<Response>;\n\n  /** @internal */\n  constructor(\n      req: Request, private _dom: BrowserJsonp, private baseResponseOptions?: ResponseOptions) {\n    if (req.method !== RequestMethod.Get) {\n      throw new TypeError(JSONP_ERR_WRONG_METHOD);\n    }\n    this.request = req;\n    this.response = new Observable<Response>((responseObserver: Observer<Response>) => {\n\n      this.readyState = ReadyState.Loading;\n      const id = this._id = _dom.nextRequestID();\n\n      _dom.exposeConnection(id, this);\n\n      // Workaround Dart\n      // url = url.replace(/=JSONP_CALLBACK(&|$)/, `generated method`);\n      const callback = _dom.requestCallback(this._id);\n      let url: string = req.url;\n      if (url.indexOf('=JSONP_CALLBACK&') > -1) {\n        url = url.replace('=JSONP_CALLBACK&', `=${callback}&`);\n      } else if (url.lastIndexOf('=JSONP_CALLBACK') === url.length - '=JSONP_CALLBACK'.length) {\n        url = url.substring(0, url.length - '=JSONP_CALLBACK'.length) + `=${callback}`;\n      }\n\n      const script = this._script = _dom.build(url);\n\n      const onLoad = (event: Event) => {\n        if (this.readyState === ReadyState.Cancelled) return;\n        this.readyState = ReadyState.Done;\n        _dom.cleanup(script);\n        if (!this._finished) {\n          let responseOptions =\n              new ResponseOptions({body: JSONP_ERR_NO_CALLBACK, type: ResponseType.Error, url});\n          if (baseResponseOptions) {\n            responseOptions = baseResponseOptions.merge(responseOptions);\n          }\n          responseObserver.error(new Response(responseOptions));\n          return;\n        }\n\n        let responseOptions = new ResponseOptions({body: this._responseData, url});\n        if (this.baseResponseOptions) {\n          responseOptions = this.baseResponseOptions.merge(responseOptions);\n        }\n\n        responseObserver.next(new Response(responseOptions));\n        responseObserver.complete();\n      };\n\n      const onError = (error: Error) => {\n        if (this.readyState === ReadyState.Cancelled) return;\n        this.readyState = ReadyState.Done;\n        _dom.cleanup(script);\n        let responseOptions = new ResponseOptions({body: error.message, type: ResponseType.Error});\n        if (baseResponseOptions) {\n          responseOptions = baseResponseOptions.merge(responseOptions);\n        }\n        responseObserver.error(new Response(responseOptions));\n      };\n\n      script.addEventListener('load', onLoad);\n      script.addEventListener('error', onError);\n\n      _dom.send(script);\n\n      return () => {\n        this.readyState = ReadyState.Cancelled;\n        script.removeEventListener('load', onLoad);\n        script.removeEventListener('error', onError);\n        this._dom.cleanup(script);\n      };\n    });\n  }\n\n  /**\n   * Callback called when the JSONP request completes, to notify the application\n   * of the new data.\n   */\n  finished(data?: any) {\n    // Don't leak connections\n    this._finished = true;\n    this._dom.removeConnection(this._id);\n    if (this.readyState === ReadyState.Cancelled) return;\n    this._responseData = data;\n  }\n}\n\n/**\n * A {@link ConnectionBackend} that uses the JSONP strategy of making requests.\n *\n * @deprecated see https://angular.io/guide/http\n */\n@Injectable()\nexport class JSONPBackend extends ConnectionBackend {\n  /** @internal */\n  constructor(private _browserJSONP: BrowserJsonp, private _baseResponseOptions: ResponseOptions) {\n    super();\n  }\n\n  createConnection(request: Request): JSONPConnection {\n    return new JSONPConnection(request, this._browserJSONP, this._baseResponseOptions);\n  }\n}\n"],"sourceRoot":""}